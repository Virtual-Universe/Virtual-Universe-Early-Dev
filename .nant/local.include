<!-- -*- xml -*- -->
<!-- please leave the top comment for us emacs folks -->
<property name="nunitcmd" value="nunit-console" />

<!-- This target produces a source distribution of Universeulator -->
<!-- TODO: A few parameters still need to be tweaked after running this - need to do this automatically with sed or similar -->
<target name="distsrc">
  <copy file="bin/Universe.ini.example" tofile="bin/Universe.ini"/>
  <copy file="bin/config-include/StandaloneCommon.ini.example" tofile="bin/config-include/StandaloneCommon.ini"/>
  <copy file="bin/config-include/FlotsamCache.ini.example" tofile="bin/config-include/FlotsamCache.ini"/>
  <!-- delete files generated by runprebuild.sh which had to be run in order to generate the build file for this target-->
  <delete>
    <fileset basedir="Universe">
      <include name="**/*.build"/>
      <include name="**/*.csproj*"/>
      <include name="**/*.dll.build"/>
      <include name="**/*.pidb"/>
      <exclude name="Tools/Universe.32BitLaunch/**"/>
      <exclude name="Tools/Robust.32BitLaunch/**"/>
      <exclude name="Tools/LaunchSLClient/**"/>
    </fileset>
  </delete>
  <delete>
    <fileset>
      <include name="Universe.build"/>
      <include name="Universe.sln"/>
    </fileset>
  </delete>
</target>

<property name="distbindir" value="distbin" />
<!-- This target produces a binary directory called distbin/ in Universe/bin which contains everything needed for binary distribution -->
<!-- For safety/laziness sake, we're going to take the approach of deleting known extraneous files here rather than
     trying to copy across only the essential ones -->
<target name="distbin">
  <delete dir="${distbindir}"/>
  <copy todir="${distbindir}">
    <fileset>
      <include name="**"/>
    </fileset>
  </copy>
  <delete dir="${distbindir}/Universe"/>
  <delete dir="${distbindir}/Prebuild"/>
  <delete dir="${distbindir}/%temp%"/>
  <delete dir="${distbindir}/.nant"/>
  <delete dir="${distbindir}/ThirdParty"/>
  <delete>
    <fileset basedir="${distbindir}">
      <include name="compile.bat"/>
      <include name="BUILDING.md"/>
      <include name="Makefile"/>
      <include name="nant-color"/>
      <include name="Universe.*"/>
      <include name="prebuild.xml"/>
      <include name="runprebuild*"/>
      <include name="TESTING.txt"/>
      <include name="TestResult.xml"/>
      <include name="bin/Universe.Server.ini"/>
      <include name="bin/Regions/Regions.ini"/>
      <include name="bin/*.db"/>
      <include name="**/.git/**"/>
      <include name=".gitignore"/>
      <include name=".hgignore"/>
    </fileset>
  </delete>
</target>

<target name="test" depends="build, find-nunit">
  <setenv name="MONO_THREADS_PER_CPU" value="100" />

  <!-- Unit Test Assembly -->
  <!-- if you want to add more unit tests it's important that you add
  the assembly here as an exec, and you add the fail clause later.
  This lets all the unit tests run and tells you if they fail at the
  end, instead of stopping short -->
  <exec program="${nunitcmd}" failonerror="true" resultproperty="testresult.universe.tests">
    <arg value="./bin/Universe.Tests.dll" />
  </exec>
  <fail message="Failures reported in unit tests." unless="${int::parse(testresult.universe.tests)==0}" /> 

  <exec program="${nunitcmd}" failonerror="true" resultproperty="testresult.universe.framework.tests">
    <arg value="./bin/Universe.Framework.Tests.dll" />
  </exec>
  <fail message="Failures reported in unit tests." unless="${int::parse(testresult.universe.framework.tests)==0}" /> 

  <exec program="${nunitcmd}" failonerror="true" resultproperty="testresult.universe.framework.servers.tests">
    <arg value="./bin/Universe.Framework.Servers.Tests.dll" />
  </exec>
  <fail message="Failures reported in unit tests." unless="${int::parse(testresult.universe.framework.servers.tests)==0}" /> 

  <exec program="${nunitcmd}" failonerror="true" resultproperty="testresult.universe.framework.serialization.tests">
    <arg value="./bin/Universe.Framework.Serialization.Tests.dll" />
  </exec>
  <fail message="Failures reported in unit tests." unless="${int::parse(testresult.universe.framework.serialization.tests)==0}" /> 

  <exec program="${nunitcmd}" failonerror="true" resultproperty="testresult.universe.region.clientstack.lindencaps.tests">
    <arg value="./bin/Universe.Region.ClientStack.LindenCaps.Tests.dll" />
  </exec>
  <fail message="Failures reported in unit tests." unless="${int::parse(testresult.universe.region.clientstack.lindencaps.tests)==0}" /> 

  <exec program="${nunitcmd}" failonerror="true" resultproperty="testresult.universe.region.clientstack.lindenudp.tests">
    <arg value="./bin/Universe.Region.ClientStack.LindenUDP.Tests.dll" />
  </exec>
  <fail message="Failures reported in unit tests." unless="${int::parse(testresult.universe.region.clientstack.lindenudp.tests)==0}" /> 

  <exec program="${nunitcmd}" failonerror="true" resultproperty="testresult.universe.region.scriptengine.tests">
    <arg value="./bin/Universe.Region.ScriptEngine.Tests.dll" />
  </exec>
  <fail message="Failures reported in unit tests." unless="${int::parse(testresult.universe.region.scriptengine.tests)==0}" /> 

  <exec program="${nunitcmd}" failonerror="true" resultproperty="testresult.universe.region.coremodules.tests">
    <arg value="./bin/Universe.Region.CoreModules.Tests.dll" />
  </exec>
  <fail message="Failures reported in unit tests." unless="${int::parse(testresult.universe.region.coremodules.tests)==0}" /> 

<!--
  <exec program="${nunitcmd}" failonerror="true" resultproperty="testresult.universe.region.optionalmodules.tests">
    <arg value="./bin/Universe.Region.OptionalModules.Tests.dll" />
  </exec>
  <fail message="Failures reported in unit tests." unless="${int::parse(testresult.universe.region.optionalmodules.tests)==0}" /> 
-->

  <exec program="${nunitcmd}" failonerror="true" resultproperty="testresult.universe.region.framework.tests">
    <arg value="./bin/Universe.Region.Framework.Tests.dll" />
  </exec>
  <fail message="Failures reported in unit tests." unless="${int::parse(testresult.universe.region.framework.tests)==0}" /> 

  <exec program="${nunitcmd}" failonerror="true" resultproperty="testresult.universe.data.tests">
    <arg value="./bin/Universe.Data.Tests.dll" />
  </exec>
  <fail message="Failures reported in unit tests." unless="${int::parse(testresult.universe.data.tests)==0}" /> 

  <exec program="${nunitcmd}" failonerror="true" resultproperty="testresult.universe.capabilities.handlers.tests">
    <arg value="./bin/Universe.Capabilities.Handlers.Tests.dll" />
  </exec>
  <fail message="Failures reported in unit tests." unless="${int::parse(testresult.universe.capabilities.handlers.tests)==0}" /> 

  <exec program="${nunitcmd}" failonerror="true" resultproperty="testresult.universe.server.handlers.tests">
    <arg value="./bin/Universe.Server.Handlers.Tests.dll" />
  </exec>
  <fail message="Failures reported in unit tests." unless="${int::parse(testresult.universe.server.handlers.tests)==0}" /> 

  <exec program="${nunitcmd}" failonerror="true" resultproperty="testresult.universe.services.inventoryservice.tests">
    <arg value="./bin/Universe.Services.InventoryService.Tests.dll" />
  </exec>
  <fail message="Failures reported in unit tests." unless="${int::parse(testresult.universe.services.inventoryservice.tests)==0}" /> 

  <exec program="${nunitcmd}" failonerror="true" resultproperty="testresult.universe.tests.permissions">
    <arg value="./bin/Universe.Tests.Permissions.dll" />
  </exec>
  <fail message="Failures reported in unit tests." unless="${int::parse(testresult.universe.tests.permissions)==0}" /> 
  
<delete dir="%temp%"/>
</target>

<target name="test-stress" depends="build, find-nunit">
  <setenv name="MONO_THREADS_PER_CPU" value="100" />

  <exec program="${nunitcmd}" failonerror="true" resultproperty="testresult.universe.tests.stress">
    <arg value="./bin/Universe.Tests.Stress.dll" />
  </exec>

  <fail message="Failures reported in stress tests." unless="${int::parse(testresult.universe.tests.stress)==0}" /> 
  <delete dir="%temp%"/>
</target>

<target name="test-perf" depends="build, find-nunit">
  <setenv name="MONO_THREADS_PER_CPU" value="100" />

  <exec program="${nunitcmd}" failonerror="true" resultproperty="testresult.universe.tests.performance">
    <arg value="./bin/Universe.Tests.Performance.dll" />
  </exec>

  <fail message="Failures reported in performance tests." unless="${int::parse(testresult.universe.tests.performance)==0}" /> 
  <delete dir="%temp%"/>
</target>

<target name="find-nunit">
  <exec program="which" failonerror="false"
        resultproperty="hasnunit2">
    <arg value="nunit-console2" />
  </exec>

  <property name="nunitcmd" value="nunit-console2"
    if="${int::parse(hasnunit2)==0}" />
  <property name="nunitcmd" value="nunit-console"
    if="${int::parse(hasnunit2)==1}" />
</target>

<!-- this is used for panda test execution -->
<!-- work in progress -->

<target name="test-xml" depends="build, find-nunit">
  <mkdir dir="test-results" failonerror="false" />
  <!-- Unit Test Assembly -->
  <exec program="${nunitcmd}" failonerror="false" resultproperty="testresult.universe.tests">
    <arg value="./bin/Universe.Tests.dll" />
    <arg value="-xml=test-results/Universe.Tests.dll-Results.xml" />
  </exec>

  <exec program="${nunitcmd}" failonerror="false" resultproperty="testresult.universe.framework.tests">
    <arg value="./bin/Universe.Framework.Tests.dll" />
    <arg value="-xml=test-results/Universe.Framework.Tests.dll-Results.xml" />
  </exec>

 <exec program="${nunitcmd}" failonerror="false" resultproperty="testresult.universe.framework.serialization.tests">
    <arg value="./bin/Universe.Framework.Serialization.Tests.dll" />
    <arg value="-xml=test-results/Universe.Framework.Serialization.Tests.dll-Results.xml" />
  </exec>

 <exec program="${nunitcmd}" failonerror="false" resultproperty="testresult.universe.framework.servers.tests">
    <arg value="./bin/Universe.Framework.Servers.Tests.dll" />
    <arg value="-xml=test-results/Universe.Framework.Servers.Tests.dll-Results.xml" />
  </exec>

 <exec program="${nunitcmd}" failonerror="false" resultproperty="testresult.universe.region.clientstack.lindencaps.tests">
    <arg value="./bin/Universe.Region.ClientStack.LindenCaps.Tests.dll" />
    <arg value="-xml=test-results/Universe.Region.ClientStack.LindenCaps.Tests.dll-Results.xml" />
  </exec>

 <exec program="${nunitcmd}" failonerror="false" resultproperty="testresult.universe.region.clientstack.lindenudp.tests">
    <arg value="./bin/Universe.Region.ClientStack.LindenUDP.Tests.dll" />
    <arg value="-xml=test-results/Universe.Region.ClientStack.LindenUDP.Tests.dll-Results.xml" />
  </exec>

 <exec program="${nunitcmd}" failonerror="false" resultproperty="testresult.universe.region.scriptengine.tests">
    <arg value="./bin/Universe.Region.ScriptEngine.Tests.dll" />
    <arg value="-xml=test-results/Universe.Region.ScriptEngine.Tests.dll-Results.xml" />
  </exec>

 <exec program="${nunitcmd}" failonerror="false" resultproperty="testresult.universe.region.coremodules.tests">
    <arg value="./bin/Universe.Region.CoreModules.Tests.dll" />
    <arg value="-xml=test-results/Universe.Region.CoreModules.Tests.dll-Results.xml" />
  </exec>

<!--
 <exec program="${nunitcmd}" failonerror="false" resultproperty="testresult.universe.region.optionalmodules.tests">
    <arg value="./bin/Universe.Region.OptionalModules.Tests.dll" />
    <arg value="-xml=test-results/Universe.Region.OptionalModules.Tests.dll-Results.xml" />
  </exec>
-->

 <exec program="${nunitcmd}" failonerror="false" resultproperty="testresult.universe.region.framework.tests">
    <arg value="./bin/Universe.Region.Framework.Tests.dll" />
    <arg value="-xml=test-results/Universe.Region.Framework.Tests.dll-Results.xml" />
  </exec>

 <exec program="${nunitcmd}" failonerror="false" resultproperty="testresult.universe.data.tests">
    <arg value="./bin/Universe.Data.Tests.dll" />
    <arg value="-xml=test-results/Universe.Data.Tests.dll-Results.xml" />
  </exec>

 <exec program="${nunitcmd}" failonerror="false" resultproperty="testresult.universe.capabilities.handlers.tests">
    <arg value="./bin/Universe.Capabilities.Handlers.Tests.dll" />
    <arg value="-xml=test-results/Universe.Capabilities.Handlers.Tests.dll-Results.xml" />
  </exec>

 <exec program="${nunitcmd}" failonerror="false" resultproperty="testresult.universe.server.handlers.tests">
    <arg value="./bin/Universe.Server.Handlers.Tests.dll" />
    <arg value="-xml=test-results/Universe.Server.Handlers.Tests.dll-Results.xml" />
  </exec>

 <exec program="${nunitcmd}" failonerror="false" resultproperty="testresult.universe.services.inventoryservice.tests">
    <arg value="./bin/Universe.Services.InventoryService.Tests.dll" />
    <arg value="-xml=test-results/Universe.Services.InventoryService.Tests.dll-Results.xml" />
  </exec>

 <exec program="${nunitcmd}" failonerror="false" resultproperty="testresult.universe.tests.permissions">
    <arg value="./bin/Universe.Tests.Permissions.dll" />
    <arg value="-xml=test-results/Universe.Tests.Permissions.dll-Results.xml" />
  </exec>
  
 <fail message="Failures reported in unit tests." unless="${int::parse(testresult.universe.tests)==0}" /> 
 <fail message="Failures reported in unit tests." unless="${int::parse(testresult.universe.framework.tests)==0}" /> 
 <fail message="Failures reported in unit tests." unless="${int::parse(testresult.universe.framework.servers.tests)==0}" /> 
 <fail message="Failures reported in unit tests." unless="${int::parse(testresult.universe.region.clientstack.lindenudp.tests)==0}" />
 <fail message="Failures reported in unit tests." unless="${int::parse(testresult.universe.region.scriptengine.tests)==0}" /> 
 <fail message="Failures reported in unit tests." unless="${int::parse(testresult.universe.region.coremodules.tests)==0}" /> 
<!--  <fail message="Failures reported in unit tests." unless="${int::parse(testresult.universe.region.optionalmodules.tests)==0}" /> -->
 <fail message="Failures reported in unit tests." unless="${int::parse(testresult.universe.region.framework.tests)==0}" /> 
 <fail message="Failures reported in unit tests." unless="${int::parse(testresult.universe.data.tests)==0}" /> 
 <fail message="Failures reported in unit tests." unless="${int::parse(testresult.universe.capabilities.handlers.tests)==0}" /> 
 <fail message="Failures reported in unit tests." unless="${int::parse(testresult.universe.services.inventoryservice.tests)==0}" /> 
 <fail message="Failures reported in unit tests." unless="${int::parse(testresult.universe.tests.permissions)==0}" /> 
</target>

<target name="doxygen">
  <exec program="doxygen" workingdir="doc" commandline="doxygen.conf" />
</target>
